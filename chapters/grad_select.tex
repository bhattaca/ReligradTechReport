% Gradient selection

\section{Selecting Gradients}
\label{sec:grad_select}

Once we have identified reliable gradients,
we use those gradients to compute planes tangent to the isosurface
in the neighborhood of each cube $\cb$.
Algorithm~MergeSharp in~\cite{bw-cisec-13}
uses gradients at the vertices of $\cb$ and cubes adjacent to $\cb$.
Unfortunately, if cube $\cb$ intersects a gradient discontinuity,
this neighborhood may contain no or few reliable gradients.
We can only guarantee that a vertex $v \in A_i$ will pass the angle test
in Step~3 of \FindReliable (Algorithm~\ref{alg:phi3}),
if $N(v''') \subseteq A_i$ for each collinear sequence $(v,v',v'',v''')$
where $v' \in N^T(v)$.
Thus, vertex $v$ should be at least four edges from the boundary of $A_i$
in each of the tangent directions.

Algorithm \ExtendReliable (Algorithm~\ref{alg:extend}) increases
the number of reliable gradients close to the gradient discontinuities.
On the other hand, if a cube contains an isosurface corner,
then the distance to reliable gradients may be even larger than four.
Thus, we look for reliable gradients in a $9 \times 9 \times 9$ region
around cube $\cb$ or distance 4 from the vertices of $\cb$.

We are interested only in selecting gradients 
which determine isosurface tangent planes near $\cb$.
We use three tests on vertices in the $9 \times 9 \times 9$ region
to select such gradients.
First, we are only interested in vertices which are near the isosurface.
Thus, we only choose vertices from edges
where one endpoint has scalar value below
the isovalue and one endpoint has scalar value at or above the isovalue.
Second, we are only interested in vertices whose gradients generate planes
which are close to $\cb$.
Let $h_v$ be the tangent plane generated by the gradient at vertex $v$.
We construct a cube $\cb'$ of size $1.5 \times 1.5 \times 1.5$ centered at $\cb$
and only choose a vertex $v$ if the plane $h_v$ intersects $\cb'$.
(We use a cube $\cb'$ which is slightly larger than $\cb$ 
because noise and approximation errors can cause a tangent plane $h_v$ 
to slightly miss $\cb$.)

Finally, we only want to choose a vertex which is far from $\cb$
if a closer vertex is not chosen.
Let $Q$ be the set of vertices which do NOT have reliable gradients
and are in the $9 \times 9 \times 9$ subgrid centered at $\cb$.
Let $Q_\cb$ be the vertices of $\cb$.
Let $G_\cb$ be the graph whose vertices are $Q \cup Q_\cb$
and whose edges are $(u,v)$ where $(u,v)$ is a grid edge.
We find the connected component $G'$ of $G_\cb$ containing $Q_\cb$.
A grid vertex $u \not\in V(G')$ is on the boundary of $G'$
if $(u,v)$ is a grid edge and $v$ is in $V(G')$.
We only a choose a vertex if it is in $Q_\cb$
or if it is on the boundary of $G'$.

Applying the three tests gives a set of vertices 
and their reliable gradients around cube $\cb$.
As described in the next section,
we use these gradients to determine the locations 
of isosurface vertices on sharp features.

